---
title: "Badanie opóźnień w ruchu pociągów w okresie 16.05.2022 - 30.05.2022"
output: html_document
date: "2024-10-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Wstęp

## Cele
Zbadać częstotliwość oraz skalę opóźnień pociągów w danym okresie oraz zależność ich od sytuacji meteorologicznej. Przedstawić tę zależność za pomocą wizualizacji.

## Hipotezy
Przed badaniem robimy przypuszczenie, iż im gorsza sytuacja pogodowa, tzn. im więcej opadów pewnego dnia oraz im mniejsza temperatura, tym opóźnienia będą większe i częstsze.

## Zbiór danych

1. [Opóźnienia pociągów](https://www.kaggle.com/datasets/bartek358/train-delays)

**Opis**: The dataset contains information about delays on polish railroads published by the Polish State Railways in real time. Data was scraped from https://infopasazer.intercity.pl. It covers the period from the midnight of 2022-05-16 until the midnight of 2022-05-30. Observations were collected every 5 minutes.

**Zmienne**:

    datetime - timestamp at which the sample was collected (Warsaw time)
    id - train ID
    carrier - the name of the carrier (mainly its PKP Intercity)
    date - date of the train departure
    connection - beginning and the destination for the train
    arrival - planned arrival time at the destination
    delay - current estimated delay
    name - train station name
    
Dataset został opublikowany w roku 2022 i do teraz ma nie więcej niż 800 pobrań. Nie znalazłem również żadnych raportów z wykorzystaniem tego zbioru, więc można stwierdzić, że zbiór jest dość unikatowy.

2. [Pogoda](https://open-meteo.com/en/docs/historical-weather-api#start_date=2022-05-16&end_date=2022-05-30&hourly=temperature_2m,rain,wind_speed_10m&daily=&wind_speed_unit=ms&timezone=Europe%2FBerlin)

**Opis**: Są to archiwowe dane pogodowe dla okresu, odpowiadającego okresu zbierania danych w pierwszym zbiorze. Za lokalizaję wzięto przybliżone koordynaty geograficznego centrum Polski.

## Zarys projektu

W tym projekcie po czyszczeniu zbioru danych oraz konwertowaniu poszczególnych zmiennych do właściwego dla nas typu zajmiemy się badaniem zależności pomiędzy pewnymi typami zmiennych za pomocą np. wyznaczenia korelacji pomiędzy zmiennymi numerycznymi. Znajdziemy też średnie opóźnień dla poszczególnych przewoźników lub relacji, uwzględnimy dane pogodowe, żeby wyłapać tę zależność oraz wesprzymy nasze wnioski odpowiednimi wizualicjami.  

# Realizacja

## Przygotowanie zbiorow danych

Zacznijmy od importowania zbiorow oraz wszystkich potrzebnych bibliotek

```{r}
#rm(list = ls())
#dftemp = read.csv("delays.csv")
#lockBinding("dftemp", globalenv())
```

```{r}
library(dplyr)
library(tidyverse)
library(chron)
library(ggplot2)
weather = read.csv("open-meteo-52.55N13.41E38m.csv")

df = dftemp
```

Zajmijmy sie najpierw zbiorem opoznien

```{r}
summary(df)
sum(is.na(df))
```

```{r}
df$datetime = strptime(df$datetime, format = "%Y-%m-%d %H:%M")
df$date = strptime(df$date, format = '%Y-%m-%d')
df$arrival = strptime(df$arrival, format = '%H:%M')
```
```{r}
split_data = do.call(rbind, strsplit(df$connection, " - "))
df$start = split_data[,1]
df$end = split_data[,2]
rm(split_data)
df = df[, -5]
```
```{r}
df$id = as.factor(df$id)
df$carrier = as.factor(df$carrier)
df$delay = as.numeric(gsub(" min", "", df$delay))
df$name = as.factor(df$name)
df$start = as.factor(df$start)
df$end = as.factor(df$end)
```

Teraz zbiorem danych pogodowych
```{r}
colnames(weather) = c(weather[2, 1], weather[2, 2], weather[2, 3], weather[2, 4], weather[2, 5],weather[2, 6])
weather = weather[c(-1, -2), ]

sum(is.na(weather))
weather$time = strptime(weather$time, format = '%Y-%m-%d T %H:%M')
```


```{r}
length(unique(df$name))
df$delay_factor = cut(df$delay,
                       breaks = c(-Inf, 0, 5, 30, 60, Inf),
                       labels = c("0 min", "1-5 min", "6-30 min", "31-60 min", "> 60 min"),
                       right = TRUE)

delay_over_60_by_carrier <- df[df$delay_factor == "> 60 min",] %>%
  group_by(carrier)%>%
  summarise("Delays_Over_60_mins" = length(delay_factor))

```

```{r}
total_delays <- sum(delay_over_60_by_carrier$Delays_Over_60_mins)

ggplot(delay_over_60_by_carrier, aes(x = carrier, y = log(Delays_Over_60_mins), fill = carrier)) +
  geom_bar(stat = "identity", color = "black", width = 0.7) +
  labs(
    title = "Delays Over 60 Minutes by Carrier",
    x = "Carrier",
    y = "log(Delays Over 60 Minutes)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_fill_brewer(palette = "Set3") +
  scale_y_continuous(limits = c(0, max(log(delay_over_60_by_carrier$Delays_Over_60_mins)) + 5), expand = c(0, 0.5)) +  # Adjust y-axis limits
  geom_text(
    aes(
      label = paste0(
        round(log(Delays_Over_60_mins), 2), 
        "\n(", round((Delays_Over_60_mins / total_delays) * 100, 2), "%)"
      )
    ),
    vjust = -0.3,  # Adjust as necessary
    size = 4,     # Adjust for readability
    color = "black",
    position = position_dodge(width = 0.7)
  )
```

```{r}
ggplot(df, aes(y = delay)) +
  geom_boxplot(
    fill = "lightblue",     # Fill color for the box
    color = "darkblue",     # Color for the outline of the box
    outlier.colour = "red", # Color for outliers
    outlier.shape = 16,     # Shape for outliers
    outlier.size = 2,       # Size of the outlier points
    notch = TRUE             # Notched box for better visualization
  ) +
  labs(
    title = "Boxplot of Delays",
    y = "Delay (minutes)",
    x = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16), # Center title and bold
    axis.title.y = element_text(size = 14),                          # Y-axis title size
    axis.text.y = element_text(size = 12)                            # Y-axis text size
  )
```

```{r}

```




